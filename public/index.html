
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ‰‹åŠç”Ÿæˆå™¨ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .style-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .style-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .style-card.selected {
            border: 3px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .premium-style {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1f2937;
        }
        .result-image {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ­ AIæ‰‹åŠç”Ÿæˆå™¨</h1>
            <p class="text-xl text-white opacity-90">AIé©±åŠ¨ - å°†ä½ çš„ç…§ç‰‡è½¬æ¢ä¸ºç²¾ç¾çš„3Dæ‰‹åŠæ¨¡å‹</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Panel - Controls -->
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">ğŸ¨ åˆ›ä½œè®¾ç½®</h2>
                    
                    <!-- Image Upload -->
                    <div class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡</label>
                        <div class="border-2 border-dashed border-white/30 rounded-lg p-6 text-center hover:border-white/50 transition-colors">
                            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('imageInput').click()">
                                <div id="uploadPrompt" class="text-white/80">
                                    <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°è¿™é‡Œ</p>
                                    <p class="text-sm opacity-70">æ”¯æŒ JPG, PNG, GIF æ ¼å¼</p>
                                </div>
                                <div id="imagePreview" class="hidden">
                                    <img id="previewImg" class="max-w-full max-h-48 mx-auto rounded-lg shadow-lg">
                                    <p class="text-white/80 mt-2">ç‚¹å‡»é‡æ–°é€‰æ‹©å›¾ç‰‡</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Style Selection -->
                    <div class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">ğŸ­ æ‰‹åŠé£æ ¼</label>
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Premium Custom Style -->
                            <div class="style-card premium-style rounded-lg p-3 text-center col-span-2 selected" data-style="custom" onclick="selectStyle('custom')">
                                <div class="text-2xl mb-1">â­</div>
                                <div class="font-bold">çœŸäººå®šåˆ¶æ‰‹åŠ</div>
                                <div class="text-xs opacity-80">é«˜åº¦è¿˜åŸçœŸå®ç…§ç‰‡</div>
                            </div>
                            
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="realistic" onclick="selectStyle('realistic')">
                                <div class="text-2xl mb-1">ğŸ‘¤</div>
                                <div class="text-white font-medium">çœŸäººé£æ ¼</div>
                            </div>
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="cartoon" onclick="selectStyle('cartoon')">
                                <div class="text-2xl mb-1">ğŸª</div>
                                <div class="text-white font-medium">å¡é€šé£æ ¼</div>
                            </div>
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="anime" onclick="selectStyle('anime')">
                                <div class="text-2xl mb-1">ğŸŒ¸</div>
                                <div class="text-white font-medium">åŠ¨æ¼«é£æ ¼</div>
                            </div>
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="ancient" onclick="selectStyle('ancient')">
                                <div class="text-2xl mb-1">ğŸ›ï¸</div>
                                <div class="text-white font-medium">å¤é£é£æ ¼</div>
                            </div>
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="modern" onclick="selectStyle('modern')">
                                <div class="text-2xl mb-1">ğŸ™ï¸</div>
                                <div class="text-white font-medium">ç°ä»£é£æ ¼</div>
                            </div>
                            <div class="style-card bg-white/20 rounded-lg p-3 text-center" data-style="cyberpunk" onclick="selectStyle('cyberpunk')">
                                <div class="text-2xl mb-1">ğŸ¤–</div>
                                <div class="text-white font-medium">èµ›åšæœ‹å…‹</div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Figurine Options -->
                    <div id="customOptions" class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">ğŸ¯ å®šåˆ¶é€‰é¡¹</label>
                        <div class="space-y-3">
                            <div class="bg-white/10 rounded-lg p-3">
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="keepPets" checked class="mr-2 rounded">
                                    åŒ…å«å® ç‰©ï¼ˆå¦‚æœç…§ç‰‡ä¸­æœ‰ï¼‰
                                </label>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="keepAccessories" checked class="mr-2 rounded">
                                    ä¿ç•™æ‰€æœ‰é…é¥°ï¼ˆèƒŒåŒ…ã€å¸½å­ç­‰ï¼‰
                                </label>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="sceneBase" checked class="mr-2 rounded">
                                    æƒ…æ™¯å¼åº•åº§è®¾è®¡
                                </label>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3">
                                <label class="block text-white mb-2">äººç‰©æ¯”ä¾‹</label>
                                <select id="proportionSelect" class="w-full bg-white/20 text-white rounded p-2 border border-white/30">
                                    <option value="q-realistic">Qç‰ˆå†™å®ï¼ˆæ¨èï¼‰</option>
                                    <option value="realistic">å®Œå…¨å†™å®</option>
                                    <option value="chibi">è¶…QèŒç‰ˆ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Clothing Options -->
                    <div class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">ğŸ‘— æœè£…é€‰æ‹©</label>
                        <select id="clothingSelect" class="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 focus:border-white/50 focus:outline-none">
                            <option value="">ä¿æŒåŸè£…</option>
                            <option value="casual">ä¼‘é—²è£…</option>
                            <option value="formal">æ­£è£…</option>
                            <option value="traditional">ä¼ ç»Ÿæœè£…</option>
                            <option value="fantasy">å¥‡å¹»æœè£…</option>
                            <option value="uniform">åˆ¶æœ</option>
                            <option value="cosplay">Cosplayæœè£…</option>
                            <option value="outdoor">æˆ·å¤–è¿åŠ¨è£…</option>
                            <option value="beach">æµ·æ»©è£…</option>
                        </select>
                    </div>

                    <!-- Base Options -->
                    <div class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">â­• åº•åº§æ ·å¼</label>
                        <select id="baseSelect" class="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 focus:border-white/50 focus:outline-none">
                            <option value="transparent">é€æ˜åœ†å½¢åº•åº§</option>
                            <option value="scene">æƒ…æ™¯åº•åº§ï¼ˆæ ¹æ®ç…§ç‰‡èƒŒæ™¯ï¼‰</option>
                            <option value="wooden">æœ¨è´¨åº•åº§</option>
                            <option value="marble">å¤§ç†çŸ³åº•åº§</option>
                            <option value="metal">é‡‘å±åº•åº§</option>
                            <option value="crystal">æ°´æ™¶åº•åº§</option>
                        </select>
                    </div>

                    <!-- Scene Options -->
                    <div class="mb-6">
                        <label class="block text-white text-lg font-semibold mb-3">ğŸ–¥ï¸ åœºæ™¯è®¾ç½®</label>
                        <div class="space-y-2">
                            <label class="flex items-center text-white">
                                <input type="checkbox" id="showScreen" checked class="mr-2 rounded">
                                æ˜¾ç¤ºç”µè„‘å±å¹•ä¸Šçš„å»ºæ¨¡è¿‡ç¨‹
                            </label>
                            <label class="flex items-center text-white">
                                <input type="checkbox" id="showBox" checked class="mr-2 rounded">
                                æ˜¾ç¤ºBANDAIé£æ ¼åŒ…è£…ç›’
                            </label>
                            <label class="flex items-center text-white">
                                <input type="checkbox" id="showDesk" checked class="mr-2 rounded">
                                ç”µè„‘æ¡Œåœºæ™¯
                            </label>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn" onclick="generateFigurine()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg transition-colors text-lg shadow-lg">
                        <span id="generateText">ğŸ¨ ç”Ÿæˆæ‰‹åŠ</span>
                        <div id="generateLoading" class="hidden flex items-center justify-center">
                            <div class="loading-spinner mr-3"></div>
                            AIç”Ÿæˆä¸­...
                        </div>
                    </button>
                </div>

                <!-- Right Panel - Results -->
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">ğŸ–¼ï¸ ç”Ÿæˆç»“æœ</h2>
                    
                    <div id="resultArea" class="text-center">
                        <div id="placeholderContent" class="text-white/60 py-12">
                            <svg class="mx-auto h-24 w-24 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-xl">ä¸Šä¼ ç…§ç‰‡å¹¶é€‰æ‹©é£æ ¼å¼€å§‹åˆ›ä½œ</p>
                            <p class="text-sm opacity-70 mt-2">ä½ çš„AIæ‰‹åŠå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        </div>
                        
                        <div id="resultContent" class="hidden">
                            <div id="resultImage" class="mb-4">
                                <!-- Generated image will be displayed here -->
                            </div>
                            
                            <div class="flex gap-3 justify-center mt-4 flex-wrap">
                                <button onclick="downloadImage()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                                </button>
                                <button onclick="shareImage()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ğŸ”— åˆ†äº«
                                </button>
                                <button onclick="generateAnother()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generated Prompt Display (Hidden for mystery) -->
            <div id="promptPreviewContainer" class="hidden">
                <div class="mt-8 glass-effect rounded-xl p-6">
                    <h3 class="text-xl font-bold text-white mb-3">ğŸ¤– AIæç¤ºè¯é¢„è§ˆ</h3>
                    <div id="promptPreview" class="bg-black/30 rounded-lg p-4 text-white/80 font-mono text-sm min-h-20">
                        <em>é€‰æ‹©é£æ ¼åå°†æ˜¾ç¤ºç”Ÿæˆçš„æç¤ºè¯...</em>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedStyle = 'custom';
        let uploadedImage = null;
        let currentImageUrl = null;

        // AIé£æ ¼æ¨¡æ¿
        const aiStyleTemplates = {
            custom: `æ ¹æ®ä¸Šä¼ çš„ç…§ç‰‡ï¼Œç²¾ç¡®è¿˜åŸåˆ›å»ºä¸€ä¸ªçœŸäººå®šåˆ¶æ‰‹åŠæ¨¡å‹ã€‚è¦æ±‚ï¼š
1. é‡‡ç”¨Qç‰ˆå†™å®é£æ ¼ï¼Œä¿æŒäººç‰©çœŸå®é¢éƒ¨ç‰¹å¾ä½†ç•¥å¾®å¯çˆ±åŒ–
2. å®Œå…¨æŒ‰ç…§ç…§ç‰‡ä¸­çš„æœè£…æ ·å¼ã€é¢œè‰²ã€è´¨æ„Ÿè¿›è¡Œè¿˜åŸ
3. ä¿ç•™æ‰€æœ‰ç»†èŠ‚ï¼šå‘å‹ã€è¡¨æƒ…ã€å§¿æ€ã€é…é¥°ç­‰
4. å¦‚æœç…§ç‰‡ä¸­æœ‰å¤šä¸ªäººç‰©ï¼Œè¯·å…¨éƒ¨è¿˜åŸ
5. æ‰‹åŠæè´¨åº”å‘ˆç°ä¸“ä¸šçº§åˆ¶ä½œå·¥è‰ºï¼Œè¡¨é¢å…‰æ»‘ç»†è…»`,

            realistic: "åˆ›å»ºçœŸå®ä¸–ç•Œé£æ ¼çš„æ‰‹åŠæ¨¡å‹ï¼Œé«˜åº¦å†™å®ï¼Œä¿æŒç…§ç‰‡äººç‰©çš„çœŸå®æ¯”ä¾‹å’Œç‰¹å¾ï¼Œç»†èŠ‚ä¸°å¯Œ",
            
            cartoon: "åˆ›å»ºå¡é€šé£æ ¼çš„å¯çˆ±æ‰‹åŠæ¨¡å‹ï¼Œåœ†æ¶¦é€ å‹ï¼Œè‰²å½©æ˜äº®ï¼ŒQç‰ˆæ¯”ä¾‹ï¼Œä¿æŒäººç‰©è¯†åˆ«åº¦",
            
            anime: "åˆ›å»ºæ—¥å¼åŠ¨æ¼«é£æ ¼çš„ç²¾ç¾æ‰‹åŠæ¨¡å‹ï¼Œå¤§çœ¼ç›ï¼Œç²¾è‡´é¢éƒ¨ç‰¹å¾ï¼ŒåŠ¨æ¼«åŒ–å¤„ç†ä½†ä¿æŒåŸå§‹ç‰¹è‰²",
            
            ancient: "åˆ›å»ºå¤é£ä¼ ç»Ÿé£æ ¼çš„å…¸é›…æ‰‹åŠæ¨¡å‹ï¼Œèå…¥å¤è£…å…ƒç´ ï¼Œä¸œæ–¹ç¾å­¦ï¼Œå…¸é›…æ°”è´¨",
            
            modern: "åˆ›å»ºç°ä»£éƒ½å¸‚é£æ ¼çš„æ—¶å°šæ‰‹åŠæ¨¡å‹ï¼Œç°ä»£æœé¥°æ­é…ï¼Œéƒ½å¸‚æ„Ÿï¼Œæ—¶å°šåŠ¨æ„Ÿ",
            
            cyberpunk: "åˆ›å»ºèµ›åšæœ‹å…‹é£æ ¼çš„æœªæ¥æ„Ÿæ‰‹åŠæ¨¡å‹ï¼Œç§‘æŠ€å…ƒç´ ï¼Œéœ“è™¹æ•ˆæœï¼Œæœªæ¥ä¸»ä¹‰è®¾è®¡"
        };

        const clothingTemplates = {
            '': '',
            casual: 'ï¼Œæ›´æ¢ä¸ºæ—¶å°šä¼‘é—²è£…æ­é…',
            formal: 'ï¼Œæ›´æ¢ä¸ºæ­£å¼è¥¿è£…æˆ–ä¼˜é›…ç¤¼æœ',
            traditional: 'ï¼Œæ›´æ¢ä¸ºç²¾ç¾ä¼ ç»Ÿæ°‘æ—æœè£…',
            fantasy: 'ï¼Œæ›´æ¢ä¸ºå¥‡å¹»é£æ ¼æœè£…',
            uniform: 'ï¼Œæ›´æ¢ä¸ºç²¾ç¾åˆ¶æœ',
            cosplay: 'ï¼Œæ›´æ¢ä¸ºçƒ­é—¨åŠ¨æ¼«è§’è‰²Cosplayæœè£…',
            outdoor: 'ï¼Œæ›´æ¢ä¸ºä¸“ä¸šæˆ·å¤–è¿åŠ¨è£…å¤‡',
            beach: 'ï¼Œæ›´æ¢ä¸ºæ—¶å°šæµ·æ»©ä¼‘é—²è£…'
        };

        const baseTemplates = {
            transparent: 'ä½¿ç”¨åœ†å½¢é€æ˜äºšå…‹åŠ›åº•åº§',
            scene: 'ä½¿ç”¨æƒ…æ™¯å¼åº•åº§è®¾è®¡ï¼Œè¿˜åŸç…§ç‰‡èƒŒæ™¯çš„å…³é”®å…ƒç´ ',
            wooden: 'ä½¿ç”¨ç²¾ç¾æŠ›å…‰æœ¨è´¨åœ†å½¢åº•åº§',
            marble: 'ä½¿ç”¨é«˜çº§å¤§ç†çŸ³çº¹ç†åœ†å½¢åº•åº§',
            metal: 'ä½¿ç”¨é‡‘å±è´¨æ„Ÿåœ†å½¢åº•åº§',
            crystal: 'ä½¿ç”¨æ°´æ™¶é€æ˜åœ†å½¢åº•åº§'
        };

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 10 * 1024 * 1024) { // 10MB
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result;
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = uploadedImage;
                    
                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('imagePreview').classList.remove('hidden');
                    
                    updatePromptPreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function selectStyle(style) {
            selectedStyle = style;
            
            // Update visual selection
            document.querySelectorAll('.style-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.style-card[data-style="${style}"]`).classList.add('selected');
            
            // Show/hide custom options
            const customOptions = document.getElementById('customOptions');
            if (style === 'custom') {
                customOptions.classList.remove('hidden');
            } else {
                customOptions.classList.add('hidden');
            }
            
            updatePromptPreview();
        }

        function updatePromptPreview() {
            const clothing = document.getElementById('clothingSelect').value;
            const base = document.getElementById('baseSelect').value;
            const showScreen = document.getElementById('showScreen').checked;
            const showBox = document.getElementById('showBox').checked;
            const showDesk = document.getElementById('showDesk').checked;

            let prompt = aiStyleTemplates[selectedStyle];
            
            // Custom style specific additions
            if (selectedStyle === 'custom') {
                const keepPets = document.getElementById('keepPets')?.checked;
                const keepAccessories = document.getElementById('keepAccessories')?.checked;
                const sceneBase = document.getElementById('sceneBase')?.checked;
                const proportion = document.getElementById('proportionSelect')?.value;
                
                if (keepPets) {
                    prompt += '\n6. å¦‚æœç…§ç‰‡ä¸­æœ‰å® ç‰©ï¼ˆç‹—ã€çŒ«ç­‰ï¼‰ï¼Œè¯·å®Œå…¨è¿˜åŸå® ç‰©çš„å“ç§ã€é¢œè‰²ã€å¤§å°å’Œæ‰€æœ‰é…é¥°ï¼ˆç‰µå¼•ç»³ã€é¡¹åœˆç­‰ï¼‰';
                }
                
                if (keepAccessories) {
                    prompt += '\n7. ç²¾ç¡®è¿˜åŸäººç‰©çš„æ‰€æœ‰é…é¥°ç»†èŠ‚ï¼šèƒŒåŒ…ã€å¸½å­ã€çœ¼é•œã€é¦–é¥°ã€æ‰‹è¡¨ç­‰ï¼ŒåŒ…æ‹¬é¢œè‰²ã€æè´¨ã€å“ç‰Œæ ‡è¯†';
                }
                
                if (proportion === 'realistic') {
                    prompt = prompt.replace('Qç‰ˆå†™å®é£æ ¼', 'å®Œå…¨å†™å®é£æ ¼ï¼Œ1:1çœŸå®æ¯”ä¾‹');
                } else if (proportion === 'chibi') {
                    prompt = prompt.replace('Qç‰ˆå†™å®é£æ ¼', 'è¶…QèŒåŒ–é£æ ¼ï¼Œå¤´èº«æ¯”2:1');
                }
            }
            
            // æ·»åŠ æœè£…å˜æ›´
            prompt += clothingTemplates[clothing];
            
            // æ·»åŠ åº•åº§è®¾è®¡
            prompt += `\n\nåº•åº§è®¾è®¡ï¼š${baseTemplates[base]}ï¼Œåº•åº§ä¸Šä¸åº”æœ‰ä»»ä½•æ–‡å­—æˆ–æ ‡è¯†ã€‚`;
            
            // æ·»åŠ åœºæ™¯å…ƒç´ 
            if (showDesk || showScreen || showBox) {
                prompt += '\n\nåœºæ™¯å¸ƒç½®ï¼š';
                if (showDesk) {
                    prompt += 'å°†æ•´ä¸ªæ‰‹åŠæ”¾ç½®åœ¨ç°ä»£é£æ ¼çš„ç”µè„‘æ¡Œé¢ä¸Šï¼›';
                }
                if (showScreen) {
                    prompt += 'åœ¨ç”µè„‘æ˜¾ç¤ºå™¨å±å¹•ä¸Šå±•ç¤ºè¯¥æ‰‹åŠçš„ZBrush 3Då»ºæ¨¡åˆ¶ä½œè¿‡ç¨‹ç•Œé¢ï¼›';
                }
                if (showBox) {
                    prompt += 'åœ¨æ˜¾ç¤ºå™¨æ—è¾¹æ”¾ç½®ä¸€ä¸ªå°æœ‰åŸå§‹äººç‰©æ’ç”»çš„BANDAIé£æ ¼ç²¾ç¾æ‰‹åŠåŒ…è£…ç›’ã€‚';
                }
            }
            
            // æ·»åŠ è´¨é‡è¦æ±‚
            prompt += '\n\næŠ€æœ¯è¦æ±‚ï¼šä¸“ä¸šçº§æ‰‹åŠåˆ¶ä½œå·¥è‰ºï¼Œé«˜è´¨é‡3Dæ¸²æŸ“ï¼ŒæŸ”å’Œä¸“ä¸šæ‘„å½±å…‰ç…§ï¼Œç²¾ç»†æè´¨è¡¨ç°ï¼Œç”»é¢æ¯”ä¾‹3:4ç«–ç‰ˆæ„å›¾ã€‚';

            document.getElementById('promptPreview').textContent = prompt;
        }

        async function generateFigurine() {
            if (!uploadedImage) {
                alert('è¯·å…ˆä¸Šä¼ ä¸€å¼ ç…§ç‰‡ï¼');
                return;
            }

            // Show loading state
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoading = document.getElementById('generateLoading');
            
            generateBtn.disabled = true;
            generateText.classList.add('hidden');
            generateLoading.classList.remove('hidden');

            try {
                // Get the final prompt
                const prompt = document.getElementById('promptPreview').textContent;
                
                // å‡†å¤‡è¯·æ±‚æ•°æ®
                const requestData = {
                    prompt: prompt,
                    image: uploadedImage,
                    style: selectedStyle,
                    options: {
                        keepPets: document.getElementById('keepPets')?.checked,
                        keepAccessories: document.getElementById('keepAccessories')?.checked,
                        sceneBase: document.getElementById('sceneBase')?.checked,
                        proportion: document.getElementById('proportionSelect')?.value,
                        clothing: document.getElementById('clothingSelect').value,
                        base: document.getElementById('baseSelect').value,
                        showScreen: document.getElementById('showScreen').checked,
                        showBox: document.getElementById('showBox').checked,
                        showDesk: document.getElementById('showDesk').checked
                    }
                };

                console.log('å‘é€ç”Ÿæˆè¯·æ±‚...');
                
                // è°ƒç”¨åç«¯APIï¼Œå¢åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    // æ·»åŠ è¶…æ—¶è®¾ç½®
                    signal: AbortSignal.timeout(60000) // 60ç§’è¶…æ—¶
                });

                if (!response.ok) {
                    // å°è¯•å®‰å…¨åœ°è§£æé”™è¯¯å“åº”
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    } catch (jsonError) {
                        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œæä¾›æ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
                        throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}, æ— æ³•è§£æå“åº”å†…å®¹`);
                    }
                }

                // å®‰å…¨åœ°è§£æå“åº”
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    throw new Error('æ— æ³•è§£ææœåŠ¡å™¨å“åº”ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•');
                }
                
                if (result.success && result.imageUrl) {
                    currentImageUrl = result.imageUrl;
                    showResult(result.imageUrl);
                } else {
                    throw new Error('APIè¿”å›äº†æ— æ•ˆçš„ç»“æœ');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥:\n1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateText.classList.remove('hidden');
                generateLoading.classList.add('hidden');
            }
        }

        function showResult(imageUrl) {
            // ä¿å­˜å½“å‰å›¾ç‰‡URLç”¨äºé‡è¯•åŠ è½½
            currentImageUrl = imageUrl;
            
            document.getElementById('placeholderContent').classList.add('hidden');
            document.getElementById('resultContent').classList.remove('hidden');
            
            // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
            const resultImage = document.getElementById('resultImage');
            resultImage.innerHTML = `
                <div class="relative">
                    <img src="${imageUrl}" alt="ç”Ÿæˆçš„æ‰‹åŠ" class="result-image mx-auto">
                    <div id="imageErrorOverlay" class="hidden absolute inset-0 bg-black/60 rounded-xl flex flex-col items-center justify-center text-white p-4">
                        <div class="text-5xl mb-3">âš ï¸</div>
                        <p class="text-center mb-4">å›¾ç‰‡åŠ è½½å¤±è´¥</p>
                        <button onclick="retryLoadImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ”„ é‡è¯•åŠ è½½
                        </button>
                    </div>
                </div>
                <p class="text-white/80 text-sm mt-3">âœ¨ AIç”ŸæˆæˆåŠŸï¼</p>
                <p class="text-white/60 text-xs mt-1">å¦‚æœå›¾ç‰‡æ— æ³•æ˜¾ç¤ºï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹çš„"é‡è¯•åŠ è½½"æŒ‰é’®</p>
            `;
            
            // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            const img = resultImage.querySelector('img');
            img.onerror = function() {
                document.getElementById('imageErrorOverlay').classList.remove('hidden');
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', imageUrl);
            };
        }
        
        function retryLoadImage() {
            if (currentImageUrl) {
                const img = document.querySelector('#resultImage img');
                const errorOverlay = document.getElementById('imageErrorOverlay');
                
                // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é˜²æ­¢ç¼“å­˜é—®é¢˜
                const timestamp = new Date().getTime();
                const urlWithTimestamp = currentImageUrl.includes('?') 
                    ? `${currentImageUrl}&t=${timestamp}` 
                    : `${currentImageUrl}?t=${timestamp}`;
                
                img.src = urlWithTimestamp;
                errorOverlay.classList.add('hidden');
                
                // å†æ¬¡æ·»åŠ é”™è¯¯å¤„ç†
                img.onerror = function() {
                    errorOverlay.classList.remove('hidden');
                    console.error('é‡è¯•åŠ è½½å¤±è´¥:', urlWithTimestamp);
                    alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ³•:\n1. æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥\n2. å°è¯•ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨\n3. ç¨åå†è¯•ï¼Œå› ä¸ºå›¾ç‰‡URLå¯èƒ½æœ‰è®¿é—®é™åˆ¶');
                };
            }
        }

        function downloadImage() {
            if (currentImageUrl) {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥æ¥ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.href = currentImageUrl;
                link.download = `ai-figurine-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
            }
        }

        function shareImage() {
            if (currentImageUrl) {
                // ä½¿ç”¨ Web Share API æˆ–å¤åˆ¶é“¾æ¥
                if (navigator.share) {
                    navigator.share({
                        title: 'AIæ‰‹åŠç”Ÿæˆå™¨',
                        text: 'çœ‹çœ‹æˆ‘ç”¨AIç”Ÿæˆçš„æ‰‹åŠï¼',
                        url: currentImageUrl
                    });
                } else {
                    // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(currentImageUrl).then(() => {
                        alert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    }).catch(() => {
                        alert('åˆ†äº«åŠŸèƒ½éœ€è¦HTTPSç¯å¢ƒæˆ–ç°ä»£æµè§ˆå™¨æ”¯æŒ');
                    });
                }
            } else {
                alert('æ²¡æœ‰å¯åˆ†äº«çš„å›¾ç‰‡');
            }
        }

        function generateAnother() {
            generateFigurine();
        }

        // åˆå§‹åŒ–
        selectStyle('custom');
        updatePromptPreview();

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('clothingSelect').addEventListener('change', updatePromptPreview);
        document.getElementById('baseSelect').addEventListener('change', updatePromptPreview);
        document.getElementById('showScreen').addEventListener('change', updatePromptPreview);
        document.getElementById('showBox').addEventListener('change', updatePromptPreview);
        document.getElementById('showDesk').addEventListener('change', updatePromptPreview);
        
        // è‡ªå®šä¹‰é€‰é¡¹çš„äº‹ä»¶ç›‘å¬å™¨
        ['keepPets', 'keepAccessories', 'sceneBase', 'proportionSelect'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', updatePromptPreview);
            }
        });

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(255,255,255,0.1)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const fakeEvent = {
                        target: { files: [file] }
                    };
                    handleImageUpload(fakeEvent);
                }
            }
        });

        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        fetch('/api/health')
            .then(res => res.json())
            .then(data => {
                console.log('APIçŠ¶æ€:', data);
                if (!data.hasApiKey) {
                    console.warn('âš ï¸ APIå¯†é’¥æœªé…ç½®');
                }
            })
            .catch(err => {
                console.warn('âš ï¸ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡:', err);
            });
    </script>
<script>window.parent.postMessage({ action: "ready" }, "*"); 
 
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});
</script></body>
</html>
